trigger:
- master
- feature/*
- test/*

pool:
  vmImage: 'ubuntu-20.04'

steps:
- task: JavaToolInstaller@0
  inputs:
    versionSpec: '8'
    jdkArchitectureOption: 'x86'
    jdkSourceOption: 'PreInstalled'

- task: CmdLine@2
  displayName: Maven
  inputs:
    script: |
      mvn compile package install -Dmaven.test.skip=true      
    workingDirectory: '$(Build.SourcesDirectory)'

- task: CmdLine@2
  displayName: Analyze with NG SAST
  inputs:
    script: |
      curl https://cdn.shiftleft.io/download/sl > sl && chmod a+rx sl
      ./sl analyze --app copper-cms --tag branch=$(Build.SourceBranchName) --force --wait --sca --java --cpg target/copper-server-1.15.2.war
    workingDirectory: '$(Build.SourcesDirectory)/copper-server'
  env:
    SHIFTLEFT_ACCESS_TOKEN: $(SHIFTLEFT_ACCESS_TOKEN)
    SL_CPG_OPTS: "-J-Xms2g -J-Xmx6g"
