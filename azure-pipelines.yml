trigger:
- master
- feature/*

pool:
  vmImage: 'ubuntu-20.04'

steps:

- task: CmdLine@2
  displayName: Download NG SAST
  inputs:
    script: |
      curl https://cdn.shiftleft.io/download/sl > sl && chmod a+rx sl
    workingDirectory: '$(Build.SourcesDirectory)'

- task: CmdLine@2
  displayName: Analyze with NG SAST
  inputs:
    script: |
      mvn package install -Dmaven.test.skip=true
      cd copper-server
      ../sl analyze --app copper-cms --tag branch=$(Build.SourceBranchName) --force --wait --sca --java --cpg target/copper-server-1.15.2.war
    workingDirectory: '$(Build.SourcesDirectory)'
  env:
    SHIFTLEFT_ACCESS_TOKEN: $(SHIFTLEFT_ACCESS_TOKEN)
    SL_CPG_OPTS: "-J-Xms2g -J-Xmx6g"
